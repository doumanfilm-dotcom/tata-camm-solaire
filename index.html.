<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gestion Tata Camm Solaire</title>
<style>
body{font-family: Arial, Helvetica, sans-serif; margin:0; padding:0; background:#fff;}
.header{background:#fff;padding:16px;display:flex;align-items:center;border-bottom:4px solid #ff7a00;}
.logo{width:84px;height:84px;margin-right:12px;border-radius:8px;}
.title{font-size:20px;font-weight:700;color:#ff7a00;}
.slogan{font-size:12px;color:#0fa29a;}
.container{padding:16px;}
.card{border:1px solid #eee;padding:12px;border-radius:10px;margin-bottom:12px;}
.btn{display:inline-block;padding:8px 12px;border-radius:6px;background:#ff7a00;color:#fff;text-decoration:none;margin:6px 4px;cursor:pointer;}
.btn-secondary{background:#0fa29a;}
.input{padding:8px;border-radius:6px;border:1px solid #ccc;width:120px;}
.small{font-size:13px;color:#444;}
.table{width:100%;border-collapse:collapse;margin-top:8px;}
.table th, .table td{border:1px solid #ddd;padding:6px;text-align:left;font-size:13px;}
.footer{padding:12px;text-align:center;color:#888;font-size:12px;}
</style>
</head>
<body>
<div class="header">
  <img src="logo.png" class="logo" alt="logo" id="logoImg"/>
  <div>
    <div class="title" id="companyName">TATA CAMM SOLAIRE</div>
    <div class="slogan" id="companySlogan">La sécurité sans limites</div>
    <div style="margin-top:6px;"><a id="callBtn" class="btn btn-secondary" href="tel:+22372960628">Appeler +223 7296 0628</a></div>
  </div>
</div>

<div class="container">
  <div class="card">
    <div class="small">Stock actuel</div>
    <div style="font-size:28px;font-weight:700;color:#0fa29a;" id="stockCount">20</div>
    <div class="small" style="margin-top:8px;">Prix d'achat/unité: <b id="purchasePrice">15000</b> fcfa &nbsp; | &nbsp; Frais livraison/unité: <b id="shippingPrice">15000</b> fcfa</div>
  </div>

  <div class="card">
    <div style="font-weight:700;">Acheter (ajouter au stock)</div>
    <div style="margin-top:8px;">
      Quantité: <input id="buyQty" class="input" type="number" value="1" min="1" />
      <button class="btn" onclick="buy()">Ajouter</button>
    </div>
    <div class="small" style="margin-top:8px;">(Enregistrez un achat si vous recevez des caméras)</div>
  </div>

  <div class="card">
    <div style="font-weight:700;">Vendre caméras</div>
    <div style="margin-top:8px;">
      Quantité: <input id="sellQty" class="input" type="number" value="1" min="1" />
      <label style="margin-left:8px;"><input type="checkbox" id="withInstall" checked /> Installation (+10 000 fcfa /caméra)</label>
      <button class="btn" onclick="sell()">Vendre</button>
    </div>
    <div class="small" style="margin-top:8px;">Prix de vente par unité: <b id="salePrice">50000</b> fcfa</div>
  </div>

  <div class="card">
    <div style="font-weight:700;">Résumé & Répartition</div>
    <div class="small">Bénéfice par unité (vente - coût total): <b id="profitPerUnit">20000</b> fcfa</div>
    <div style="margin-top:8px;">
      Total perçu propriétaire: <b id="ownerTotal">0</b> fcfa<br/>
      Total pour investisseur: <b id="investorTotal">0</b> fcfa
    </div>
  </div>

  <div class="card">
    <div style="font-weight:700;">Journal des ventes</div>
    <table class="table" id="salesTable">
      <thead><tr><th>Date</th><th>Qté</th><th>Total Profit</th><th>Propriétaire</th><th>Investisseur</th><th>Installation</th></tr></thead>
      <tbody></tbody>
    </table>
    <div style="margin-top:8px;">
      <button class="btn" onclick="exportCSV()">Exporter CSV</button>
      <button class="btn" onclick="resetData()">Réinitialiser</button>
    </div>
  </div>

  <div class="card">
    <div style="font-weight:700;">Paramètres</div>
    <div style="margin-top:8px;">
      Nom entreprise: <input id="nameInput" class="input" value="TATA CAMM SOLAIRE" />
      Slogan: <input id="sloganInput" class="input" value="La sécurité sans limites" /><br/>
      Téléphone: <input id="phoneInput" class="input" value="+22372960628" />
      <button class="btn" onclick="saveSettings()">Sauvegarder</button>
    </div>
  </div>

  <div class="footer">App simple de gestion - Doumanfilm. Stock initial = 20. Prix: achat 15k, livraison 15k, vente 50k, installation 10k.</div>
</div>

<script>
// Defaults (données fournies)
const DEFAULTS = {
  stock: 20,
  purchasePrice: 15000,
  shippingPrice: 15000,
  salePrice: 50000,
  installationFee: 10000,
  profitSplitOwner: 0.6,
  profitSplitInvestor: 0.4
};

function get(key, fallback) {
  const v = localStorage.getItem(key);
  if (v === null) return fallback;
  try { return JSON.parse(v); } catch(e){ return v; }
}
function set(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

function init(){
  if (get('stock')===null) set('stock', DEFAULTS.stock);
  if (get('purchasePrice')===null) set('purchasePrice', DEFAULTS.purchasePrice);
  if (get('shippingPrice')===null) set('shippingPrice', DEFAULTS.shippingPrice);
  if (get('salePrice')===null) set('salePrice', DEFAULTS.salePrice);
  if (get('installationFee')===null) set('installationFee', DEFAULTS.installationFee);
  if (get('sales')===null) set('sales', []);
  if (get('ownerTotal')===null) set('ownerTotal', 0);
  if (get('investorTotal')===null) set('investorTotal', 0);
  if (get('company')===null) set('company', {name: 'TATA CAMM SOLAIRE', slogan: 'La sécurité sans limites', phone: '+22372960628'});
  refreshUI();
}

function refreshUI(){
  document.getElementById('stockCount').innerText = get('stock', DEFAULTS.stock);
  document.getElementById('purchasePrice').innerText = get('purchasePrice', DEFAULTS.purchasePrice);
  document.getElementById('shippingPrice').innerText = get('shippingPrice', DEFAULTS.shippingPrice);
  document.getElementById('salePrice').innerText = get('salePrice', DEFAULTS.salePrice);
  const perUnitProfit = get('salePrice') - (get('purchasePrice') + get('shippingPrice'));
  document.getElementById('profitPerUnit').innerText = perUnitProfit;
  document.getElementById('ownerTotal').innerText = get('ownerTotal',0);
  document.getElementById('investorTotal').innerText = get('investorTotal',0);
  // Render sales table
  const tbody = document.querySelector('#salesTable tbody');
  tbody.innerHTML = '';
  const sales = get('sales',[]);
  sales.slice().reverse().forEach(s => {
    const tr = document.createElement('tr');
    tr.innerHTML = '<td>'+s.date+'</td><td>'+s.qty+'</td><td>'+s.totalProfit+'</td><td>'+s.ownerShare+'</td><td>'+s.investorShare+'</td><td>'+s.installationTotal+'</td>';
    tbody.appendChild(tr);
  });
  // Company info
  const company = get('company');
  document.getElementById('companyName').innerText = company.name;
  document.getElementById('companySlogan').innerText = company.slogan;
  document.getElementById('callBtn').href = 'tel:'+company.phone.replace(/\s+/g,'');
  document.getElementById('nameInput').value = company.name;
  document.getElementById('sloganInput').value = company.slogan;
  document.getElementById('phoneInput').value = company.phone;
  // logo not changed here; uses assets/logo.png
}

function buy(){
  const qty = parseInt(document.getElementById('buyQty').value) || 0;
  if (qty <= 0){ alert('Quantité invalide'); return; }
  let stock = get('stock', DEFAULTS.stock);
  stock += qty;
  set('stock', stock);
  // record purchase (optional)
  const purchases = get('purchases', []);
  purchases.push({date: new Date().toLocaleString(), qty: qty, unitCost: get('purchasePrice'), shipping: get('shippingPrice')});
  set('purchases', purchases);
  alert(qty + ' caméras ajoutées au stock.');
  refreshUI();
}

function sell(){
  const qty = parseInt(document.getElementById('sellQty').value) || 0;
  const withInstall = document.getElementById('withInstall').checked;
  if (qty <= 0){ alert('Quantité invalide'); return; }
  let stock = get('stock', DEFAULTS.stock);
  if (qty > stock){ alert('Stock insuffisant'); return; }
  stock -= qty;
  set('stock', stock);

  const salePrice = get('salePrice');
  const unitCost = get('purchasePrice');
  const shipping = get('shippingPrice');
  const installFee = get('installationFee');
  const perUnitProfit = salePrice - (unitCost + shipping);
  const totalProfit = perUnitProfit * qty;
  const ownerShare = Math.round(totalProfit * get('profitSplitOwner', DEFAULTS.profitSplitOwner));
  const investorShare = Math.round(totalProfit * get('profitSplitInvestor', DEFAULTS.profitSplitInvestor));
  const installationTotal = withInstall ? (installFee * qty) : 0;
  // Owner receives ownerShare + installationTotal (installation entirely for owner)
  const ownerReceives = ownerShare + installationTotal;

  // Save sale
  const sales = get('sales', []);
  const saleRecord = {
    date: new Date().toLocaleString(),
    qty: qty,
    salePrice: salePrice,
    perUnitProfit: perUnitProfit,
    totalProfit: totalProfit,
    ownerShare: ownerShare,
    investorShare: investorShare,
    installationTotal: installationTotal,
    ownerReceives: ownerReceives
  };
  sales.push(saleRecord);
  set('sales', sales);

  // Update totals
  const ownerTotal = (get('ownerTotal',0) || 0) + ownerReceives;
  const investorTotal = (get('investorTotal',0) || 0) + investorShare;
  set('ownerTotal', ownerTotal);
  set('investorTotal', investorTotal);

  alert('Vente enregistrée. Propriétaire: '+ownerReceives+' fcfa, Investisseur: '+investorShare+' fcfa.');
  refreshUI();
}

function exportCSV(){
  const sales = get('sales',[]);
  if (!sales.length){ alert('Aucune vente à exporter'); return; }
  let csv = 'date,qty,salePrice,perUnitProfit,totalProfit,ownerShare,investorShare,installationTotal,ownerReceives\n';
  sales.forEach(s => {
    csv += [s.date, s.qty, s.salePrice, s.perUnitProfit, s.totalProfit, s.ownerShare, s.investorShare, s.installationTotal, s.ownerReceives].join(',') + '\n';
  });
  const blob = new Blob([csv], {type: 'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'sales_tata_camm_solaire.csv';
  document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 1000);
}

function resetData(){
  if (!confirm('Réinitialiser toutes les données locales ?')) return;
  localStorage.clear();
  init();
  alert('Données réinitialisées');
}

function saveSettings(){
  const company = {name: document.getElementById('nameInput').value, slogan: document.getElementById('sloganInput').value, phone: document.getElementById('phoneInput').value};
  set('company', company);
  alert('Paramètres sauvegardés');
  refreshUI();
}

init();
</script>
</body>
</html>
